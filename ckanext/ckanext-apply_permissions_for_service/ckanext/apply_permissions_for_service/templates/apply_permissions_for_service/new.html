{% extends 'apply_permissions_for_service/base.html' %}

{% block prelude %}
<h1>{{ _('Apply for permission to utilize an API') }}</h1>
{% endblock %}

{% block primary_content_inner %}
<form class="col-sm-8" method="POST">
  {% import 'macros/form.html' as form %}
  {{ form.hidden('subsystemId', value=subsystem_id) }}
  <h3>{{ _('API access application') }}</h3>
  <p>{{ _('Using this form you can apply for a permission to utilize an API for your organization. Contact information will be delivered alongside the application to the API\'s owning organization. Valtori will be notified of granted access permissions to facilitate firewall configuration.') }}</p>
  <hr>
  <h3>{{ _('Applicant information') }}</h3>
  <p>{{ _('Contact information details have been prefilled based on information provided previously during the joining procedure to the National Data Exchange Layer. You may modify the prefilled information if necessary.') }}</p>

  <p>* Required field</p>
  {% set user_org = user_managed_organizations[0] if user_managed_organizations else {} %}
  {{ form.input('organization', label=_('Organization'), is_required=True, value=h.get_translated(user_org, 'title') or '') }}
  {{ form.input('businessCode', label=_('Business code'), is_required=True, value=user_org.xroad_member_code or '') }}

  {{ form.input('contactName', label=_('Contact name'), is_required=True, value=user.fullname) }}
  {{ form.input('contactEmail', label=_('Contact email'), is_required=True, value=user.email) }}

  <hr>
  <h3>{{ _('Utilizing security server and subsystem details') }}</h3>
  <p></p>

  {% set subsystem_options = [] %}
  {% for d in user_managed_datasets %}
    {% set dataset_title = h.xroad_subsystem_path(d) or h.get_translated(d, 'title') %}
    {% do subsystem_options.append({'value': d.id, 'text': dataset_title}) %}
  {% endfor %}

  {{ form.input_multiple('ipAddress', label=_('IP address'), is_required=True, add_input='add-ip-address') }}
  <button class="btn btn-default" name="add-ip-address"><i class="fa fa-plus"></i>Add IP address</button>
  {{ form.select('subsystemCode', label=_('Subsystem code'), options=subsystem_options, is_required=True) }}

  <hr>
  <h3>{{ _('Requested API and service information') }}</h3>
  <p></p>

  <table style="width: 100%">
    <thead>
      <tr><th>{{ _('Organization name') }}</th><th>{{ _('Subsystem') }}</th></tr>
    </thead>
    <tbody>
      <tr><td>{{ h.get_translated(org, 'title') }}</td><td>{{ h.get_translated(pkg, 'title') }}</td></tr>
    </tbody>
  </table>

  {% set service_options = [] %}
  {% set service_selected = [service_id] if service_id else [] %}
  {% for res in pkg.resources %}
    {% do service_options.append({'value': res.id, 'text': res.xroad_service_code or res.name}) %}
  {% endfor %}

  {{ form.select_multiple('serviceCode', label=_('Service code'), options=service_options, is_required=True, selected=service_selected) }}
  {{ form.textarea('usageDescription', label=_('Explain how the service will be used')) }}
  {{ form.input('requestDate', type='date', label=_('Requesting access starting at')) }}

  <hr>

  <input class="btn btn-primary" type="submit" value="{{ _('Send access application') }}"></input>
  <a class="btn btn-secondary">{{ _('Cancel') }}</a>
</form>
{% endblock %}
